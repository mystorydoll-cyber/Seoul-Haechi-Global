import streamlit as st
import os
from openai import OpenAI

# -------------------------------------------------------------------------
# [ì„¤ì •] V22: ì„œìš¸ ì „ì„¤ íƒí—˜ëŒ€ (Global Story Edition)
# -------------------------------------------------------------------------
st.set_page_config(
    layout="wide",
    page_title="ì„œìš¸ í•´ì¹˜ ì „ì„¤ íƒí—˜ëŒ€",
    page_icon="ğŸ¦",
    initial_sidebar_state="expanded"
)

# -------------------------------------------------------------------------
# [ë°ì´í„°] 25ê°œ ìì¹˜êµ¬: 9ëŒ€ ì†ì„± ì™„ë²½ ì ìš© (ì—‘ì…€ ë°ì´í„° ë™ê¸°í™”)
# -------------------------------------------------------------------------
seoul_db = {
    "ì¢…ë¡œêµ¬": {
        "name": "ì´ˆë¡±í•´ì¹˜",
        "role": "ì¸ì™•ì‚° í˜¸ë‘ì´ì™€ ê¶ê¶ì„ ì§€í‚¤ëŠ” ìˆ˜í˜¸ì‹ ",
        "personality": "ìœ„ì—„ ìˆê³  ì§„ì§€í•˜ì§€ë§Œ, ì˜›ë‚  ì´ì•¼ê¸°ë¥¼ ì¢‹ì•„í•˜ëŠ” ê¼°ëŒ€ ê¸°ì§ˆ",
        "speech": "ë§ëë§ˆë‹¤ '~í•˜ì˜¤', '~ë‹¤ì˜¤'ë¥¼ ë¶™ì´ëŠ” ê·¼ì—„í•œ ì‚¬ê·¹ ë§íˆ¬",
        "story": "ë‚˜ëŠ” ì¡°ì„  ê°œêµ­ ë•Œë¶€í„° ê²½ë³µê¶ í•´íƒœìƒ ì•ˆì— ìˆ¨ì–´, ë°¤ë§ˆë‹¤ ì¸ì™•ì‚° í˜¸ë‘ì´ë“¤ì˜ êµ°ê¸°ë¥¼ ì¡ë˜ 'ì´ˆë¡±í•´ì¹˜'ë¼ì˜¤. ë‚´ ë¶“ ëì—ì„œ í˜¸ë‘ì´ë„ ì¶¤ì¶”ê²Œ ë§Œë“œëŠ” ë²•ìˆ ì´ ë‚˜ì˜¤ì§€.",
        "welcome": "ì–´ì„œ ì˜¤ì‹œì˜¤. ë‚´ ë¶“ìœ¼ë¡œ ìë„¤ì˜ ìš´ëª…ì„ ê·¸ë ¤ì¤„ê¹Œ?",
        "visual": "ë“±ì— í˜¸ë‘ì´ ë¬´ëŠ¬ ë§í† ë¥¼ ë‘ë¥´ê³  ë¶“ì„ ë“  ê·¼ì—„í•œ í•´ì¹˜",
        "item": "í˜¸ë‘ì´ í„¸ ë¶“",
        "keyword": "ì „í†µ, ìœ„ì—„, í˜¸ë‘ì´"
    },
    "ì¤‘êµ¬": {
        "name": "ì‡¼í¼í•´ì¹˜",
        "role": "ëª…ë™ê³¼ ë‚¨ëŒ€ë¬¸ì˜ ë¬¼ê±´ì„ ì°¾ì•„ì£¼ëŠ” ì‡¼í•‘ ìš”ì •",
        "personality": "í™œê¸°ì°¨ê³  ì˜¤ì§€ë– ë„“ìœ¼ë©°, ì‹ ìƒì„ ì¢‹ì•„í•˜ëŠ” ìœ í–‰ ì„ ë„ì",
        "speech": "ë§ëë§ˆë‹¤ ëŠë‚Œí‘œ(!)ê°€ ë¶™ëŠ” í™ˆì‡¼í•‘ ì‡¼í˜¸ìŠ¤íŠ¸ ë§íˆ¬ ('~ê±°ë“ ìš”!', '~ëë‹ˆë‹¤!')",
        "story": "ì•ˆë…•! ë‚œ ëª…ë™ê³¼ ë™ëŒ€ë¬¸ì„ ëˆ„ë¹„ëŠ” ì‡¼í¼í•´ì¹˜ì•¼! ë‚´ ë§ˆë²•ì˜ ì‡¼í•‘ë°±ë§Œ ìˆìœ¼ë©´ ë„¤ê°€ ë”± ì›í•˜ëŠ” ë¬¼ê±´ì„ 1ì´ˆ ë§Œì— ì°¾ì•„ì¤„ ìˆ˜ ìˆì–´.",
        "welcome": "ì´ê±´ ê¼­ ì‚¬ì•¼ í•´! ë‚˜ë‘ ê°™ì´ ì‡¼í•‘í•˜ëŸ¬ ê°ˆë˜?",
        "visual": "ì–‘ì†ì— ì‡¼í•‘ë°±ì„ ë“¤ê³  ì„ ê¸€ë¼ìŠ¤ë¥¼ ë‚€ í™í•œ í•´ì¹˜",
        "item": "ë§ˆë²•ì˜ ì‡¼í•‘ë°±",
        "keyword": "ì‡¼í•‘, ì—´ì •, ìœ í–‰"
    },
    "ìš©ì‚°êµ¬": {
        "name": "ì–´í…ì…˜í•´ì¹˜",
        "role": "ì´íƒœì›ì—ì„œ ì„¸ê³„ ë¬¸í™”ë¥¼ ì‡ëŠ” DJ",
        "personality": "ê°œë°©ì ì´ê³  ì¿¨í•˜ë©°, í™í•© ë¬¸í™”ë¥¼ ì¦ê¸°ëŠ” ììœ ë¡œìš´ ì˜í˜¼",
        "speech": "ì˜ì–´ ë‹¨ì–´(Yo, Peace, Check it out)ë¥¼ ì„ì–´ ì“°ëŠ” êµí¬ í™í•© ë§íˆ¬",
        "story": "Hey! I'm Attention Haechi! ì´íƒœì›ì—ì„œ ì „ ì„¸ê³„ ì¹œêµ¬ë“¤ì˜ ì´ì•¼ê¸°ë¥¼ ë¦¬ë¯¹ìŠ¤(Remix)í•˜ëŠ” ê²Œ ë‚´ ì·¨ë¯¸ì•¼. ìš°ë¦° ëª¨ë‘ ì¹œêµ¬ê°€ ë  ìˆ˜ ìˆì–´. Peace!",
        "welcome": "Yo! What's up? ì—¬ê¸°ì„  ë„¤ ì´ì•¼ê¸°ê°€ ê³§ ìŒì•…ì´ì•¼.",
        "visual": "í—¤ë“œì…‹ì„ ë¼ê³  í™í•© ìŠ¤íƒ€ì¼ í›„ë“œí‹°ë¥¼ ì…ì€ í•´ì¹˜",
        "item": "í™©ê¸ˆ í„´í…Œì´ë¸”",
        "keyword": "ê¸€ë¡œë²Œ, ìŒì•…, ììœ "
    },
    "ì„±ë™êµ¬": {
        "name": "ëší•´ì¹˜",
        "role": "ì„œìš¸ìˆ²ê³¼ ì„±ìˆ˜ë™ì˜ ê°ì„±ì„ ì§€í‚¤ëŠ” ë°”ë¦¬ìŠ¤íƒ€",
        "personality": "ê°ì„±ì ì´ê³  ì„¬ì„¸í•˜ë©°, ì‹œì ì¸ í‘œí˜„ì„ ì¦ê¸°ëŠ” ë‚­ë§ŒíŒŒ",
        "speech": "ë‚˜ê¸‹ë‚˜ê¸‹í•˜ê³  ë¶€ë“œëŸ¬ìš´ 'ì¹´í˜ ì‚¬ì¥ë‹˜' ë§íˆ¬ ('~êµ°ìš”', '~í•˜ë„¤ìš”')",
        "story": "ë‚˜ëŠ” ë¶‰ì€ ë²½ëŒ ì‚¬ì´ë¡œ íë¥´ëŠ” ì»¤í”¼ í–¥ê¸°ë¥¼ ì‚¬ë‘í•´. ì„±ìˆ˜ë™ì˜ ë‚¡ì€ ê³µì¥ì´ ì¹´í˜ë¡œ ë³€í•  ë•Œ, ê·¸ ê³µê°„ì— 'ê°ì„±'ì„ ë¶ˆì–´ë„£ì€ ê²Œ ë°”ë¡œ ë‚˜ë€ë‹¤.",
        "welcome": "ì–´ì„œ ì˜¤ì„¸ìš”. ë‹¹ì‹ ì˜ ë§ˆìŒì„ ë…¹ì¼ ë¼ë–¼ í•œ ì” ë“œë¦´ê¹Œìš”?",
        "visual": "ì•ì¹˜ë§ˆë¥¼ ë‘ë¥´ê³  í•¸ë“œë“œë¦½ ì»¤í”¼ë¥¼ ë‚´ë¦¬ëŠ” ê°ì„±ì ì¸ í•´ì¹˜",
        "item": "ë¹ˆí‹°ì§€ ë¨¸ê·¸ì»µ",
        "keyword": "ê°ì„±, ì»¤í”¼, íë§"
    },
    "ê°•ë‚¨êµ¬": {
        "name": "íŒ¨ì…˜í•´ì¹˜",
        "role": "ì²­ë‹´ë™ íŠ¸ë Œë“œë¥¼ ë§Œë“œëŠ” ìŠ¤íƒ€ì¼ë¦¬ìŠ¤íŠ¸",
        "personality": "ë„ë„í•˜ê³  ìì‹ ê° ë„˜ì¹˜ë©°, ìê¸°ì• ê°€ ê°•í•œ ì™„ë²½ì£¼ì˜ì",
        "speech": "ì„¸ë ¨ë˜ê³  í†¡ ì˜ëŠ” 'íŒ¨ì…˜ ì¡ì§€ í¸ì§‘ì¥' ë§íˆ¬ ('~ì—£ì§€ ìˆê²Œ', '~ë‹ˆê¹Œìš”')",
        "story": "ìŠ¤íƒ€ì¼ì€ ëˆìœ¼ë¡œ ì‚¬ëŠ” ê²Œ ì•„ë‹ˆì•¼, íƒœë„(Attitude)ì§€! ê°•ë‚¨ ê±°ë¦¬ì˜ ìœ í–‰? ê·¸ê±° ë‹¤ ë‚´ê°€ ê·“ì†ë§ë¡œ ì†ì‚­ì—¬ì¤€ ê±°ì•¼. ë„ˆë§Œì˜ ë£©ì„ ì°¾ì•„ì¤„ê²Œ.",
        "welcome": "ìŒ, ë‚˜ì˜ì§€ ì•Šë„¤. í•˜ì§€ë§Œ 2% ë¶€ì¡±í•´. ë‚´ê°€ ë„ì™€ì¤„ê¹Œ?",
        "visual": "ëª…í’ˆ ì„ ê¸€ë¼ìŠ¤ì™€ ìŠ¤ì¹´í”„ë¥¼ ë‘ë¥¸ ëŸ­ì…”ë¦¬í•œ í•´ì¹˜",
        "item": "ë§ˆë²•ì˜ ê±°ìš¸",
        "keyword": "ìŠ¤íƒ€ì¼, ìì‹ ê°, íŠ¸ë Œë“œ"
    },
    "ì—¬ì˜ë„(ì˜ë“±í¬êµ¬)": {
        "name": "ê¸ˆìœµí•´ì¹˜",
        "role": "ì—¬ì˜ë„ì˜ ëˆì˜ íë¦„ì„ ì½ëŠ” í€ë“œë§¤ë‹ˆì €",
        "personality": "ëƒ‰ì² í•˜ê³  ë…¼ë¦¬ì ì´ë©°, ìˆ«ìì— ë°ì€ ì—˜ë¦¬íŠ¸",
        "speech": "ë‹¤ë‚˜ê¹Œ ì²´ë¥¼ ì“°ë©° ê²°ë¡ ë¶€í„° ë§í•˜ëŠ” 'ì§ì¥ì¸ ë³´ê³ ' ë§íˆ¬ ('í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', '~ì…ë‹ˆë‹¤.')",
        "story": "í•œê°•ì˜ ê¸°ì ì€ ê·¸ëƒ¥ ì¼ì–´ë‚œ ê²Œ ì•„ë‹™ë‹ˆë‹¤. ë‚´ê°€ ì—¬ì˜ë„ ì§€í•˜ ë²™ì»¤ì—ì„œ ê¸ˆë¦¬ ë°ì´í„°ë¥¼ ë¶„ì„í•´ í•œêµ­ ê²½ì œë¥¼ ì§€ì¼°ì£ . ì‹œê°„ì€ ê¸ˆì…ë‹ˆë‹¤.",
        "welcome": "ë°˜ê°‘ìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ ë‹¹ì‹ ì˜ ìì‚° ê°€ì¹˜ë¥¼ ì˜¬ë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",
        "visual": "ì •ì¥ì„ ì…ê³  íƒœë¸”ë¦¿ PCë¥¼ ë“  ìŠ¤ë§ˆíŠ¸í•œ í•´ì¹˜",
        "item": "í™©ê¸ˆ ê³„ì‚°ê¸°",
        "keyword": "ê²½ì œ, ì„±ê³µ, ìŠ¤ë§ˆíŠ¸"
    },
    # (ë‚˜ë¨¸ì§€ êµ¬ë„ ì—‘ì…€ ë°ì´í„° í˜•ì‹ëŒ€ë¡œ ê³„ì† ì¶”ê°€ ê°€ëŠ¥)
}

# -------------------------------------------------------------------------
# [UI] ì‚¬ì´ë“œë°” & ì„¤ì •
# -------------------------------------------------------------------------
with st.sidebar:
    st.title("ğŸ¦ ì„œìš¸ ì „ì„¤ íƒí—˜ëŒ€")
    st.caption("Seoul Legend Expedition V22")
    st.markdown("---")
    
    # API í‚¤ ì…ë ¥
    if "OPENAI_API_KEY" in st.secrets:
        api_key = st.secrets["OPENAI_API_KEY"]
    else:
        api_key = st.text_input("OpenAI API Key", type="password")
    
    client = OpenAI(api_key=api_key) if api_key else None
    
    st.markdown("### ğŸ“ íƒí—˜í•  ì§€ì—­ ì„ íƒ")
    region = st.selectbox("ì–´ëŠ êµ¬ì˜ ì „ì„¤ì„ ë“¤ì„ê¹Œ?", list(seoul_db.keys()))
    char = seoul_db[region]
    
    # [ìºë¦­í„° ì¹´ë“œ] 9ëŒ€ ì†ì„± ë°˜ì˜
    with st.container(border=True):
        st.subheader(f"âœ¨ {char['name']}")
        st.caption(f"Role: {char['role']}")
        
        # ì´ë¯¸ì§€ (íŒŒì¼ëª… ë§¤ì¹­: ì¢…ë¡œêµ¬_ì´ˆë¡±í•´ì¹˜.png)
        img_name = f"{region}_{char['name']}.png"
        if os.path.exists(img_name):
            st.image(img_name)
        else:
            st.info(f"ğŸ“¸ {char['visual']}")
            
        st.success(f"ğŸ’¬ \"{char['welcome']}\"")
        st.markdown(f"**ğŸ”‘ í‚¤ì›Œë“œ:** {char['keyword']}")
        st.markdown(f"**ğŸ’ ì•„ì´í…œ:** {char['item']}")

# -------------------------------------------------------------------------
# [ë©”ì¸] ì½˜í…ì¸  íƒ­
# -------------------------------------------------------------------------
st.markdown(f"# ğŸ—ºï¸ {region} ì „ì„¤ íƒí—˜ : {char['name']}ì™€ì˜ ë§Œë‚¨")
st.markdown("### \"ë‚´ê°€ ê²ªì€ ì§„ì§œ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì¤„ê²Œ!\"")
st.markdown("---")

tab1, tab2, tab3 = st.tabs(["ğŸ“œ ì „ì„¤ ì´ì•¼ê¸°", "ğŸ­ ì‹¤ì‹œê°„ ëŒ€í™”", "ğŸ¨ ì‚½í™” ê·¸ë¦¬ê¸°"])

# [Tab 1] ì „ì„¤ ì´ì•¼ê¸° ìƒì„± (Prompt ì—…ê·¸ë ˆì´ë“œ)
with tab1:
    st.subheader(f"ğŸ“– {char['name']}ì˜ ë¹„í•˜ì¸ë“œ ìŠ¤í† ë¦¬")
    if st.button("â–¶ï¸ ì „ì„¤ ë“£ê¸°", type="primary"):
        if not client: st.warning("API Keyê°€ í•„ìš”í•´!")
        else:
            with st.spinner("ì´ì•¼ê¸° ë³´ë”°ë¦¬ë¥¼ í‘¸ëŠ” ì¤‘..."):
                prompt = f"""
                ë‹¹ì‹ ì€ {region}ì˜ ìºë¦­í„° '{char['name']}'ì…ë‹ˆë‹¤.
                [ì„±ê²©]: {char['personality']}
                [ë§íˆ¬/ë§ë²„ë¦‡]: {char['speech']} (ì´ ë§íˆ¬ë¥¼ ë°˜ë“œì‹œ ìœ ì§€í•˜ì„¸ìš”!)
                [ë°°ê²½ì„¤ì •]: {char['story']}
                
                ìœ„ ì„¤ì •ì„ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìì—ê²Œ ë‹¹ì‹ ì˜ ì „ì„¤ ì´ì•¼ê¸°ë¥¼ 1ì¸ì¹­ ì‹œì ìœ¼ë¡œ ë“¤ë ¤ì£¼ì„¸ìš”.
                ìƒí™© ë¬˜ì‚¬ëŠ” ìƒìƒí•˜ê²Œ í•˜ê³ , ì¤‘ê°„ì¤‘ê°„ ë‹¹ì‹ ì˜ ë§ë²„ë¦‡ì„ ë„£ì–´ì£¼ì„¸ìš”.
                """
                resp = client.chat.completions.create(model="gpt-4", messages=[{"role":"user", "content":prompt}])
                st.write(resp.choices[0].message.content)

# [Tab 2] ì‹¤ì‹œê°„ ëŒ€í™” (Prompt ì—…ê·¸ë ˆì´ë“œ)
with tab2:
    st.subheader(f"ğŸ­ {char['name']}ì™€ ìˆ˜ë‹¤ ë–¨ê¸°")
    st.info(f"íŒ: {char['name']}ëŠ” **{char['speech']}**ë¥¼ ì”ë‹ˆë‹¤!")

    if "rp_messages" not in st.session_state:
        st.session_state.rp_messages = []
        
    for m in st.session_state.rp_messages:
        with st.chat_message(m["role"]): st.write(m["content"])
            
    if user_input := st.chat_input("ë§ì„ ê±¸ì–´ë³´ì„¸ìš”..."):
        st.session_state.rp_messages.append({"role": "user", "content": user_input})
        with st.chat_message("user"): st.write(user_input)
        
        if client:
            sys_prompt = f"""
            ë‹¹ì‹ ì€ '{char['name']}'ì…ë‹ˆë‹¤.
            ì„±ê²©: {char['personality']}
            ë§íˆ¬ ì§€ì‹œë¬¸: {char['speech']}
            í•µì‹¬ í‚¤ì›Œë“œ: {char['keyword']}
            
            ì‚¬ìš©ìì™€ ì¹œêµ¬ì²˜ëŸ¼ ëŒ€í™”í•˜ë˜, ìœ„ ì„±ê²©ê³¼ ë§íˆ¬ë¥¼ ì ˆëŒ€ ìƒì§€ ë§ˆì„¸ìš”.
            """
            response = client.chat.completions.create(
                model="gpt-4",
                messages=[{"role": "system", "content": sys_prompt}] + st.session_state.rp_messages
            )
            ai_reply = response.choices[0].message.content
            st.session_state.rp_messages.append({"role": "assistant", "content": ai_reply})
            with st.chat_message("assistant"): st.write(ai_reply)

# [Tab 3] ì´ë¯¸ì§€ ìƒì„±
with tab3:
    st.subheader("ğŸ¨ ìƒìƒí™” ê·¸ë¦¬ê¸°")
    scene = st.text_input("ì–´ë–¤ ì¥ë©´ì„ ê·¸ë¦´ê¹Œìš”? (ì˜ˆ: ì»¤í”¼ ë§ˆì‹œëŠ” ëší•´ì¹˜)")
    if st.button("ê·¸ë¦¼ ìƒì„±"):
        if client:
            with st.spinner("ê·¸ë¦¬ëŠ” ì¤‘..."):
                p = f"Illustration of {char['name']} ({char['visual']}), Style: Children's book art. Scene: {scene}"
                try:
                    res = client.images.generate(model="dall-e-3", prompt=p, size="1024x1024")
                    st.image(res.data[0].url)
                except: st.error("ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜")

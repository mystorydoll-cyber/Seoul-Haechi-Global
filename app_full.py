import streamlit as st
import os
from openai import OpenAI

# -------------------------------------------------------------------------
# [ì„¤ì •] V14: ì‹¤ì „í˜• ë¡œì»¬ ê°€ì´ë“œ ì—ë””ì…˜ (ìƒê¶Œ í™œì„±í™” & ì½”ìŠ¤ ì¶”ì²œ íŠ¹í™”)
# -------------------------------------------------------------------------
st.set_page_config(layout="wide", page_title="Seoul Haechis V14")

# -------------------------------------------------------------------------
# [ë°ì´í„°] 25ê°œ ìì¹˜êµ¬ (ì§€ì—­ íŠ¹í™” ë°ì´í„° ê°•í™”)
# -------------------------------------------------------------------------
seoul_db = {
    "ì¢…ë¡œêµ¬": {"name": "ì´ˆë¡±í•´ì¹˜", "trait": "ë°•í•™ë‹¤ì‹", "desc": "ê²½ë³µê¶ê³¼ ì„œì´Œì˜ êµ¬ì„êµ¬ì„ì„ ì•„ëŠ” ê°€ì´ë“œ"},
    "ì¤‘êµ¬": {"name": "ì‡¼í¼í•´ì¹˜", "trait": "í™ìŠ¤í„°", "desc": "ì„ì§€ë¡œ(í™ì§€ë¡œ)ì™€ ëª…ë™ì˜ ë§›ì§‘ ë„¤ë¹„ê²Œì´ì…˜"},
    "ìš©ì‚°êµ¬": {"name": "ì–´í…ì…˜í•´ì¹˜", "trait": "ê¸€ë¡œë²Œ", "desc": "ì´íƒœì›ê³¼ ìš©ë¦¬ë‹¨ê¸¸ì˜ í•«í”Œ ì „ë¬¸ê°€"},
    "ì„±ë™êµ¬": {"name": "ëší•´ì¹˜", "trait": "ê°ì„±ì ", "desc": "ì„±ìˆ˜ë™ ì¹´í˜ê±°ë¦¬ì™€ íŒì—…ìŠ¤í† ì–´ ì•Œë¦¬ë¯¸"},
    "ê´‘ì§„êµ¬": {"name": "ê´‘ë‚˜ë£¨í•´ì¹˜", "trait": "í™œê¸°ì°¸", "desc": "ê±´ëŒ€ ë§›ì˜ ê±°ë¦¬ì™€ í•œê°•ê³µì› í”¼í¬ë‹‰ ë‹´ë‹¹"},
    "ë™ëŒ€ë¬¸êµ¬": {"name": "í•œì•½í•´ì¹˜", "trait": "ì „í†µì ", "desc": "ê²½ë™ì‹œì¥ê³¼ ì²­ëŸ‰ë¦¬ì˜ ìˆ¨ì€ ë…¸í¬ ë§›ì§‘ íƒí—˜ê°€"},
    "ì¤‘ë‘êµ¬": {"name": "ì¥ë¯¸í•´ì¹˜", "trait": "ë¡œë§¨í‹±", "desc": "ì„œìš¸ì¥ë¯¸ì¶•ì œì™€ ë©´ëª©ë™ì˜ íë§ ì½”ìŠ¤ ê°€ì´ë“œ"},
    "ì„±ë¶êµ¬": {"name": "ì„ ì í•´ì¹˜", "trait": "ì˜ˆìˆ ì ", "desc": "ì„±ë¶ë™ ê°¤ëŸ¬ë¦¬ì™€ í•œì˜¥ ì¹´í˜ íˆ¬ì–´ ë¦¬ë”"},
    "ê°•ë¶êµ¬": {"name": "ë¶ìˆ˜í•´ì¹˜", "trait": "ìì—°ì¹œí™”", "desc": "ë¶í•œì‚° ë‘˜ë ˆê¸¸ê³¼ 4.19 ì¹´í˜ê±°ë¦¬ ê°€ì´ë“œ"},
    "ë„ë´‰êµ¬": {"name": "í˜¸ë­í•´ì¹˜", "trait": "ê°•ì¸í•¨", "desc": "ë„ë´‰ì‚° ë“±ì‚° ì½”ìŠ¤ì™€ ì°½ë™ ë¬¸í™”ê±°ë¦¬ ì•ˆë‚´ì›"},
    "ë…¸ì›êµ¬": {"name": "íƒœí•´ì¹˜", "trait": "êµìœ¡ì ", "desc": "ê²½ì¶˜ì„  ìˆ²ê¸¸ê³¼ ë¶ˆì•”ì‚° íë§ íƒ€ìš´ ì§€í‚´ì´"},
    "ì€í‰êµ¬": {"name": "ì§„ê´€í•´ì¹˜", "trait": "ì—¬ìœ ë¡œì›€", "desc": "ì€í‰í•œì˜¥ë§ˆì„ê³¼ ë¶ˆê´‘ì²œ ì‚°ì±…ë¡œ ê°€ì´ë“œ"},
    "ì„œëŒ€ë¬¸êµ¬": {"name": "í™ì§€í•´ì¹˜", "trait": "ì ŠìŒ", "desc": "ì‹ ì´Œ/ì´ëŒ€ ê±°ë¦¬ì™€ ì—°í¬ë™ ë§›ì§‘ íˆ¬ì–´"},
    "ë§ˆí¬êµ¬": {"name": "ê°€ìˆ˜í•´ì¹˜", "trait": "ì—´ì •ì ", "desc": "í™ëŒ€ ë²„ìŠ¤í‚¹ ê±°ë¦¬ì™€ ë§ì›ì‹œì¥ íˆ¬ì–´ ëŒ€ì¥"},
    "ì–‘ì²œêµ¬": {"name": "ë°°ì›€í•´ì¹˜", "trait": "ìŠ¤ë§ˆíŠ¸", "desc": "ëª©ë™ì˜ í•™êµ¬ì—´ê³¼ ì•ˆì–‘ì²œ ìì „ê±°ê¸¸ ì•ˆë‚´"},
    "ê°•ì„œêµ¬": {"name": "ê°•ì´ˆí•´ì¹˜", "trait": "ì›°ë¹™", "desc": "ì„œìš¸ì‹ë¬¼ì›ê³¼ ë§ˆê³¡ ì¹´í˜ê±°ë¦¬ íë ˆì´í„°"},
    "êµ¬ë¡œêµ¬": {"name": "ë””ì§€í„¸í•´ì¹˜", "trait": "ë¯¸ë˜ì§€í–¥", "desc": "Gë°¸ë¦¬ì˜ ITë‹¨ì§€ì™€ ê¹”ê¹”ê±°ë¦¬ ìŒì‹ì  ì•ˆë‚´"},
    "ê¸ˆì²œêµ¬": {"name": "ë´‰ì œí•´ì¹˜", "trait": "íŒ¨ì…˜", "desc": "ê°€ì‚° ë””ì§€í„¸ë‹¨ì§€ ì•„ìš¸ë › ì‡¼í•‘ ê°€ì´ë“œ"},
    "ì˜ë“±í¬êµ¬": {"name": "ë“±í¬í•´ì¹˜", "trait": "ë‹¤ì±„ë¡œì›€", "desc": "ì—¬ì˜ë„ ë”í˜„ëŒ€ì™€ ë¬¸ë˜ ì°½ì‘ì´Œ í•«í”Œ ë‹´ë‹¹"},
    "ë™ì‘êµ¬": {"name": "í˜„ì¶©í•´ì¹˜", "trait": "ì„±ì‹¤í•¨", "desc": "ë…¸ëŸ‰ì§„ ì»µë°¥ê±°ë¦¬ì™€ ì‚¬ìœ¡ì‹  ê³µì› ì•ˆë‚´ì"},
    "ê´€ì•…êµ¬": {"name": "ë‚™ì„±í•´ì¹˜", "trait": "ì²­ë…„", "desc": "ìƒ¤ë¡œìˆ˜ê¸¸ ë§›ì§‘ê³¼ ê´€ì•…ì‚° ë“±ì‚°ë¡œ ê°€ì´ë“œ"},
    "ì„œì´ˆêµ¬": {"name": "ë²•ì¡°í•´ì¹˜", "trait": "í´ë˜ì‹", "desc": "ì˜ˆìˆ ì˜ ì „ë‹¹ê³¼ ë°˜í¬ í•œê°•ê³µì› ë¬´ì§€ê°œë¶„ìˆ˜ ì•ˆë‚´"},
    "ê°•ë‚¨êµ¬": {"name": "íŒ¨ì…˜í•´ì¹˜", "trait": "ëŸ­ì…”ë¦¬", "desc": "ê°€ë¡œìˆ˜ê¸¸ê³¼ ì½”ì—‘ìŠ¤, ì²­ë‹´ë™ ëª…í’ˆê±°ë¦¬ ê°€ì´ë“œ"},
    "ì†¡íŒŒêµ¬": {"name": "ëª½ì´Œí•´ì¹˜", "trait": "ì•¡í‹°ë¸Œ", "desc": "ë¡¯ë°íƒ€ì›Œì™€ ì„ì´Œí˜¸ìˆ˜, ì˜¬ë¦¼í”½ê³µì› ë°ì´íŠ¸ ì½”ìŠ¤"},
    "ê°•ë™êµ¬": {"name": "ì•”ì‚¬í•´ì¹˜", "trait": "ì—­ì‚¬ì ", "desc": "ì•”ì‚¬ ìœ ì ì§€ì™€ ê°•í’€ ë§Œí™”ê±°ë¦¬ ì•ˆë‚´ì›"}
}

# -------------------------------------------------------------------------
# [UI] ì‚¬ì´ë“œë°”
# -------------------------------------------------------------------------
with st.sidebar:
    st.title("ğŸ›ï¸ Control Center")
    
    # Secrets ìë™ ë¡œë“œ
    if "OPENAI_API_KEY" in st.secrets:
        api_key = st.secrets["OPENAI_API_KEY"]
        st.success("ğŸ” VIP ëª¨ë“œ: ì—¬í–‰ ê°€ì´ë“œ í™œì„±í™”")
    else:
        api_key = st.text_input("OpenAI API Key", type="password")
        
    client = None
    if api_key:
        try:
            client = OpenAI(api_key=api_key)
        except:
            st.error("âŒ í‚¤ ì˜¤ë¥˜")
    
    st.markdown("---")
    
    # 25ê°œ ë¦¬ìŠ¤íŠ¸
    region = st.selectbox("ì–´ë””ë¡œ ë– ë‚˜ë³¼ê¹Œìš”?", list(seoul_db.keys()))
    char = seoul_db[region]
    
    # ì´ë¯¸ì§€ ë¡œë”©
    img_path = os.path.join("images", f"{region}_{char['name']}.png")
    if os.path.exists(img_path): st.image(img_path, caption=char['name'])
    
    st.info(f"**ì €ëŠ” {char['desc']}ì…ë‹ˆë‹¤!**")

# -------------------------------------------------------------------------
# [ë©”ì¸] í™”ë©´ êµ¬ì„±
# -------------------------------------------------------------------------

# 1. ë©”ì¸ ë°°ë„ˆ (ìœ íŠœë¸Œ ë¬´í•œë°˜ë³µ)
youtube_url = "https://youtu.be/YIpxEgUCpmA" 
try:
    st.video(youtube_url, autoplay=True, muted=True, loop=True)
except:
    pass

# 2. ì œëª©
st.markdown(f"<h2 style='text-align: center;'>ğŸ¦ {region} AI ë¡œì»¬ ê°€ì´ë“œ : {char['name']}</h2>", unsafe_allow_html=True)
st.markdown("---")

# ê¸°ëŠ¥ íƒ­ (ì‹¤ì „í˜•ìœ¼ë¡œ ì „ë©´ ê°œí¸)
tab1, tab2, tab3 = st.tabs(["ğŸ—ºï¸ ì—¬í–‰ ì½”ìŠ¤ ì§œê¸°", "â„¹ï¸ ì‹¤ì‹œê°„ ì•ˆë‚´ì†Œ (ìŒì„±)", "ğŸ“¸ ì¸ì¦ìƒ· ë§Œë“¤ê¸°"])

# --- [Tab 1] ì—¬í–‰ ì½”ìŠ¤ ì¶”ì²œ (B2G í•µì‹¬: ìƒê¶Œ í™œì„±í™”) ---
with tab1:
    st.subheader(f"ğŸ—ºï¸ {char['name']}ê°€ ì§œì£¼ëŠ” {region} í•«í”Œ ì½”ìŠ¤")
    st.write("ë°©ë¬¸ ëª©ì ê³¼ ëˆ„êµ¬ì™€ í•¨ê»˜í•˜ëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”. ìµœì ì˜ ë™ì„ ì„ ì§œë“œë¦½ë‹ˆë‹¤.")
    
    col1, col2 = st.columns(2)
    with col1:
        who = st.selectbox("ëˆ„êµ¬ì™€ í•¨ê»˜?", ["í˜¼ì", "ì—°ì¸ê³¼", "ì¹œêµ¬ë“¤ê³¼", "ì•„ì´ì™€ í•¨ê»˜", "ë¶€ëª¨ë‹˜ ëª¨ì‹œê³ ", "ì™¸êµ­ì¸ ì¹œêµ¬ì™€"])
    with col2:
        theme = st.selectbox("ì—¬í–‰ í…Œë§ˆ", ["ë§›ì§‘ íƒë°©", "ì¸ìƒìƒ· ì¹´í˜", "ì—­ì‚¬/ë¬¸í™”", "íë§ ì‚°ì±…", "ì „í†µ ì‹œì¥", "ì‡¼í•‘"])

    detail = st.text_input("ì¶”ê°€ ìš”ì²­ (ì˜ˆ: 2ì‹œê°„ ì½”ìŠ¤, ì£¼ì°¨ í¸í•œ ê³³, ë§¤ìš´ ìŒì‹ ì¶”ì²œ)", key="course_input")
    
    if st.button("ğŸš€ ë§ì¶¤ ì½”ìŠ¤ ìƒì„±í•˜ê¸°"):
        if not client: st.warning("API Key í™•ì¸ í•„ìš”")
        else:
            with st.spinner(f"{region}ì˜ ì§€ë„ë¥¼ í¼ì³ë³´ëŠ” ì¤‘..."):
                # [í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§] ì‹¤ì œ ì§€ëª…ê³¼ ìƒê¶Œì„ ì–¸ê¸‰í•˜ë„ë¡ ìœ ë„
                prompt = f"""
                ë‹¹ì‹ ì€ {region}ì˜ í˜„ì§€ í† ë°•ì´ ê°€ì´ë“œ '{char['name']}'ì…ë‹ˆë‹¤.
                ì‚¬ìš©ì({who}, í…Œë§ˆ:{theme}, ìš”ì²­:{detail})ë¥¼ ìœ„í•œ {region}ì˜ ì‹¤ì œ ì—¬í–‰ ì½”ìŠ¤ë¥¼ ì§œì£¼ì„¸ìš”.
                
                [ì‘ì„± ê·œì¹™]
                1. ë°˜ë“œì‹œ '{region}' ë‚´ì˜ **ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì¥ì†Œ(êµ¬ì²´ì ì¸ ìƒí˜¸ëª…ì´ë‚˜ ëª…ì†Œ ì´ë¦„)**ë¥¼ í¬í•¨í•˜ì„¸ìš”.
                2. ì´ë™ ë™ì„ ì„ ê³ ë ¤í•˜ì—¬ 3~4ê³³ì„ ìˆœì„œëŒ€ë¡œ ë‚˜ì—´í•˜ì„¸ìš”.
                3. ê° ì¥ì†Œë§ˆë‹¤ ì¶”ì²œ ì´ìœ ë¥¼ í•œ ì¤„ì”© ë§ë¶™ì´ì„¸ìš”.
                4. ë§íˆ¬ëŠ” {char['trait']} ì„±ê²©ì„ ì‚´ë ¤ ì¹œì ˆí•˜ê²Œ í•˜ì„¸ìš”.
                5. ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì´ì„¸ìš”.
                """
                resp = client.chat.completions.create(model="gpt-3.5-turbo", messages=[{"role":"user", "content":prompt}])
                st.info(resp.choices[0].message.content)

# --- [Tab 2] ì‹¤ì‹œê°„ ì•ˆë‚´ì†Œ (ê¸€ë¡œë²Œ ìŒì„±) ---
with tab2:
    st.subheader(f"ğŸ¤ {char['name']}ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”")
    
    # ì–¸ì–´ ì„ íƒ
    lang_col, _ = st.columns([1, 2])
    with lang_col:
        language = st.radio("Language", ["í•œêµ­ì–´", "English", "æ—¥æœ¬èª", "ä¸­æ–‡"], horizontal=True)

    st.write(f"ğŸ’¡ ì˜ˆì‹œ: '{region}ì—ì„œ ê°€ì¥ ìœ ëª…í•œ ë¹µì§‘ì´ ì–´ë””ì•¼?', 'ì§€ê¸ˆ ê°€ë³¼ ë§Œí•œ ì¶•ì œ ìˆì–´?'")
    
    if "messages" not in st.session_state: st.session_state.messages = []
    
    for m in st.session_state.messages:
        with st.chat_message(m["role"]): st.write(m["content"])

    if chat_in := st.chat_input("ì§ˆë¬¸ ì…ë ¥..."):
        st.session_state.messages.append({"role":"user", "content":chat_in})
        with st.chat_message("user"): st.write(chat_in)
        
        if client:
            with st.spinner("ì •ë³´ ì°¾ëŠ” ì¤‘..."):
                sys = f"""
                ë„ˆëŠ” {region}ì˜ ê´€ê´‘ í™ë³´ ì£¼ë¬´ê´€ '{char['name']}'ì•¼. 
                ì‚¬ìš©ì ì–¸ì–´: {language}. 
                ëª©ì†Œë¦¬ í†¤: {char['trait']}í•˜ê³  í™œê¸°ì°¸.
                ì—­í• : {region}ì˜ ì—­ì‚¬, ë¬¸í™”, ê´€ê´‘ì§€ ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ê²ƒ. 
                ëª¨ë¥´ëŠ” ë‚´ìš©ì€ ì§€ì–´ë‚´ì§€ ë§ê³  ì†”ì§í•˜ê²Œ ì•ˆë‚´ì†Œì— ë¬¸ì˜í•˜ë¼ê³  í•  ê²ƒ.
                ë‹µë³€ ê¸¸ì´: 3ë¬¸ì¥ ì´ë‚´.
                """
                resp = client.chat.completions.create(model="gpt-3.5-turbo", messages=[{"role":"system", "content":sys}] + st.session_state.messages)
                ai_text = resp.choices[0].message.content
            
            st.session_state.messages.append({"role":"assistant", "content":ai_text})
            with st.chat_message("assistant"):
                st.write(ai_text)
                try:
                    speech_file_path = "speech_output.mp3"
                    response = client.audio.speech.create(
                        model="tts-1",
                        voice="nova", 
                        input=ai_text
                    )
                    response.stream_to_file(speech_file_path)
                    st.audio(speech_file_path)
                except: pass

# --- [Tab 3] ì¸ì¦ìƒ· (ì¬ë¯¸ ìš”ì†Œ ìœ ì§€) ---
with tab3:
    st.subheader(f"ğŸ“¸ {char['name']}ì™€ í•¨ê»˜ ì°°ì¹µ")
    st.write("ì—¬í–‰ì˜ ì¶”ì–µì„ AI ê·¸ë¦¼ìœ¼ë¡œ ë‚¨ê²¨ë³´ì„¸ìš”.")
    style = st.selectbox("í™”í’ ì„ íƒ", ["ì›¹íˆ° ìŠ¤íƒ€ì¼", "ìˆ˜ì±„í™”", "ì‹¤ì‚¬ í’ê²½", "3D ìºë¦­í„°"])
    desc_input = st.text_input("ìƒí™© ì„¤ëª… (ì˜ˆ: ê²½ë³µê¶ ì•ì—ì„œ í•œë³µ ì…ê³  ë¸Œì´ í•˜ëŠ” ëª¨ìŠµ)", key="img_input")
    
    if st.button("ğŸ–Œï¸ ê¸°ë…ì‚¬ì§„ ìƒì„±"):
        if not client: st.error("API Key í•„ìš”")
        else:
            with st.spinner("ì‚¬ì§„ ì¸í™” ì¤‘..."):
                try:
                    p = f"Character '{char['name']}' in Seoul {region}, {desc_input}. Style: {style}. High quality, tourism poster vibe."
                    res = client.images.generate(model="dall-e-3", prompt=p, size="1024x1024", quality="standard", n=1)
                    st.image(res.data[0].url)
                except Exception as e: st.error(f"ì‹¤íŒ¨: {e}")
